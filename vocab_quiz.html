<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>英単語クイズ（大学受験）</title>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <style>
      body {
        font-family: system-ui, sans-serif;
        margin: 0;
        padding: 2rem 1rem;
        background: #f9fafb;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 1.5rem;
      }
      h1 { margin: 0; }
      #loader {
        border: 2px dashed #9ca3af;
        padding: 2rem;
        text-align: center;
        width: 90%;
        max-width: 400px;
      }
      #quiz {
        display: none;
        flex-direction: column;
        gap: 1rem;
        width: 90%;
        max-width: 500px;
        background: #fff;
        padding: 2rem;
        border-radius: 0.75rem;
        box-shadow: 0 2px 6px rgb(0 0 0 / 0.1);
      }
      .option {
        display: block;
        width: 100%;
        text-align: left;
        padding: 0.75rem 1rem;
        border: 1px solid #d1d5db;
        border-radius: 0.5rem;
        cursor: pointer;
        background: #f3f4f6;
      }
      .option.correct { background: #d1fae5; border-color: #34d399; }
      .option.wrong { background: #fee2e2; border-color: #f87171; }
      #stats {
        font-size: 0.9rem;
        color: #4b5563;
      }
      #wrong-list {
        margin-top: 1rem;
      }
      #wrong-list summary {
        cursor: pointer;
        font-weight: bold;
      }
      table { width: 100%; border-collapse: collapse; }
      td { padding: 0.25rem 0.5rem; border-bottom: 1px solid #e5e7eb; }
    </style>
  </head>
  <body>
    <h1>英単語クイズ</h1>

    <div id="loader">
      <p>CSV ファイル（単語,意味）をドラッグ＆ドロップ<br>またはクリックして選択</p>
      <input type="file" id="file-input" accept=".csv" />
    </div>

    <div id="quiz">
      <div id="question" style="font-size:1.5rem;font-weight:bold;"></div>
      <div id="options"></div>
      <div id="stats"></div>
      <details id="wrong-list">
        <summary>誤答リスト (0)</summary>
        <table id="wrong-table"></table>
      </details>
    </div>

    <script>
      const fileInput = document.getElementById("file-input");
      const loader = document.getElementById("loader");
      const quiz = document.getElementById("quiz");
      const questionEl = document.getElementById("question");
      const optionsEl = document.getElementById("options");
      const statsEl = document.getElementById("stats");
      const wrongTable = document.getElementById("wrong-table");
      const wrongList = document.getElementById("wrong-list");

      let words = []; // {word, meaning}
      let current = null;
      let correctCount = 0;
      let totalCount = 0;
      let wrongAnswers = [];

      // shuffle array util
      const shuffle = (arr) => arr.sort(() => Math.random() - 0.5);

      const renderStats = () => {
        statsEl.textContent = `正答数 ${correctCount}/${totalCount} (正答率 ${totalCount?Math.round((correctCount/totalCount)*100):0}%)`;
        wrongList.querySelector("summary").textContent = `誤答リスト (${wrongAnswers.length})`;
      };

      const renderWrongTable = () => {
        wrongTable.innerHTML = wrongAnswers.map(w => `<tr><td>${w.word}</td><td>${w.meaning}</td><td>${w.selected}</td></tr>`).join("");
      };

      const nextQuestion = () => {
        if (words.length === 0) return;
        current = words[Math.floor(Math.random() * words.length)];
        questionEl.textContent = current.word;
        // prepare options
        const others = shuffle(words.filter(w => w.word !== current.word)).slice(0,3);
        const opts = shuffle([current, ...others]);
        optionsEl.innerHTML = "";
        opts.forEach(opt => {
          const btn = document.createElement("button");
          btn.className = "option";
          btn.textContent = opt.meaning;
          btn.addEventListener("click", () => {
            Array.from(optionsEl.children).forEach(b => b.disabled = true);
            totalCount++;
            if (opt === current) {
              correctCount++;
              btn.classList.add("correct");
            } else {
              btn.classList.add("wrong");
              wrongAnswers.push({word: current.word, meaning: current.meaning, selected: opt.meaning});
              renderWrongTable();
            }
            renderStats();
            setTimeout(() => {
              nextQuestion();
            }, 800);
          });
          optionsEl.appendChild(btn);
        });
      };

      const startQuiz = (data) => {
        words = shuffle(data.filter(r => r.word && r.meaning));
        correctCount = totalCount = 0;
        wrongAnswers = [];
        renderStats();
        renderWrongTable();
        loader.style.display = "none";
        quiz.style.display = "flex";
        nextQuestion();
      };

      const parseCSV = (file) => {
        Papa.parse(file, {
          header: true,
          skipEmptyLines: true,
          complete: (results) => {
            startQuiz(results.data);
          },
          error: (err) => alert("CSV 解析エラー: " + err.message)
        });
      };

      fileInput.addEventListener("change", (e) => {
        const file = e.target.files[0];
        if (file) parseCSV(file);
      });

      // Drag & Drop support
      [loader].forEach(el => {
        el.addEventListener("dragover", e => { e.preventDefault(); el.style.background="#e5e7eb"; });
        el.addEventListener("dragleave", e => { el.style.background=""; });
        el.addEventListener("drop", e => {
          e.preventDefault();
          el.style.background="";
          const file = e.dataTransfer.files[0];
          if (file) parseCSV(file);
        });
      });
    </script>
  </body>
</html>
